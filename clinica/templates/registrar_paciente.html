<!-- üëá CAMBIO 1: HEREDAMOS TODA LA ESTRUCTURA DE base.html -->
{% extends 'base.html' %}

<!-- Opcional: Cambiamos el t√≠tulo de la pesta√±a del navegador -->
{% block title %}Registrar Paciente{% endblock %}


<!-- üëá CAMBIO 2: TODO NUESTRO CONTENIDO VA DENTRO DEL BLOQUE 'content' -->
{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Registrar Paciente</h2>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div id="flash-message" data-message="{{ messages[0] }}"></div>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('pacientes.crear_paciente') }}" method="post" enctype="multipart/form-data" id="formRegistrarPaciente">
        
        <!-- ============================================== -->
        <!-- PARTE 1: DATOS PERSONALES (SIEMPRE VISIBLE) -->
        <!-- ============================================== -->
        <fieldset class="border p-3 mb-3 shadow-sm rounded-3">
            <legend class="w-auto">Datos Personales</legend>
        
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nombres" name="nombres" required>
                </div>
                <div class="col-md-3">
                    <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="apellidos" name="apellidos" required>
                </div>
                <div class="col-md-3">
                    <label for="tipo_documento" class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                    <select class="form-control" id="tipo_documento" name="tipo_documento" required>
                        <option value="">Seleccione</option>
                        <option value="CC">C√©dula de Ciudadan√≠a</option>
                        <option value="TI">Tarjeta de Identidad</option>
                        <option value="RC">Registro Civil</option>
                        <option value="CE">C√©dula de Extranjer√≠a</option>
                        <option value="PA">Pasaporte</option>
                        <option value="PPT">Permiso de Protecci√≥n</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="documento" class="form-label">Documento <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="documento" name="documento">
                </div>
            </div>
        
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" required>
                </div>
                <div class="col-md-3">
                    <label for="edad" class="form-label">Edad <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="edad" name="edad" required readonly>
                </div>
                <div class="col-md-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>
                <div class="col-md-3">
                    <label for="telefono" class="form-label">Tel√©fono <span class="text-danger">*</span></label>
                    <input type="text" pattern="\d{7,15}" title="Solo n√∫meros, entre 7 y 15 d√≠gitos" class="form-control" id="telefono" name="telefono" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="genero" class="form-label">G√©nero</label>
                    <select class="form-control" id="genero" name="genero">
                        <option value="">Seleccione</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="estado_civil" class="form-label">Estado Civil</label>
                    <select class="form-control" id="estado_civil" name="estado_civil">
                        <option value="">Seleccione</option>
                        <option value="Soltero/a">Soltero/a</option>
                        <option value="Casado/a">Casado/a</option>
                        <option value="Uni√≥n Libre">Uni√≥n Libre</option>
                        <option value="Separado/a">Separado/a</option>
                        <option value="Viudo/a">Viudo/a</option>
                    </select>
                </div>
            </div>
        </fieldset>
        
        <!-- üëá CAMBIO 3: AQU√ç ENLAZAMOS CON EL ARCHIVO DEL ACORDE√ìN -->
        {% include '_accordion_registro_paciente.html' %}
        
        <div class="mt-5 mb-5 d-flex gap-3 justify-content-center">
            <button type="submit" class="btn btn-dark">Guardar</button>
            <a href="{{ url_for('pacientes.lista_pacientes') }}" class="btn btn-secondary">Volver</a>
        </div>
    </form>
</div>
{% endblock %}


<!-- üëá CAMBIO 4: MOVEMOS LOS SCRIPTS A SU PROPIO BLOQUE -->
{% block scripts %}
    <!-- Script para mostrar el mensaje flash como alert -->
    <script>
        const flashDiv = document.getElementById("flash-message");
        if (flashDiv) {
            const mensaje = flashDiv.getAttribute("data-message");
            if (mensaje) {
                alert(mensaje);
            }
        }
    </script>
    <script>
    const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
    const edadInput = document.getElementById('edad');

    if (fechaNacimientoInput) {
        fechaNacimientoInput.addEventListener('change', function () {
            const fechaNacimiento = new Date(this.value);
            const hoy = new Date();

            let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
            const mes = hoy.getMonth() - fechaNacimiento.getMonth();

            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                edad--;
            }

            edadInput.value = edad;
        });
    }
    </script>

    <!-- Cargamos el script espec√≠fico del dentigrama -->
    <script src="{{ url_for('static', filename='js/editor_dentigrama.js') }}"></script>
{% endblock %}