{% extends "base.html" %}

{% from '_componentes_paciente.html' import render_campo, render_campo_textarea %}

{% block title %}Perfil de {{ paciente.nombres }} {{ paciente.apellidos }}{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/perfil_paciente.css') }}">
{% endblock %}


{% block content %}
<div class="container-custom">
    <!-- Encabezado con Nombre y Acciones Principales -->
    <div class="profile-header">
        <div class="info">
            <h1>{{ paciente.nombres }} {{ paciente.apellidos }}</h1>
            <p>ID de Paciente: {{ paciente.id }}</p>
        </div>
        <div class="actions">
            <a href="{{ url_for('pacientes.editar_paciente', id=paciente.id) }}" class="btn-custom btn-secondary-custom"><i data-lucide="edit-3" class="btn-icon"></i> Editar</a>
            <a href="{{ url_for('pacientes.lista_pacientes') }}" class="btn-custom btn-primary-custom"><i data-lucide="users" class="btn-icon"></i> Ver todos</a>
        </div>
    </div>

    <div class="profile-layout">
        
        <!-- ======================================================= -->
        <!-- COLUMNA 1: INFO PERSONAL Y ADMINISTRATIVA -->
        <!-- ======================================================= -->
        <div class="column">
            <div class="card-custom">
                <h3><i data-lucide="user-circle" class="card-icon"></i>Datos Personales</h3>
                <div class="data-grid">
                    <div class="data-item"><span class="label">Documento</span><span class="value">{{ paciente.tipo_documento or '' }} {{ paciente.documento or 'N/A' }}</span></div>
                    <div class="data-item"><span class="label">Teléfono</span><span class="value">{{ paciente.telefono }}</span></div>
                    <div class="data-item"><span class="label">Email</span><span class="value">{{ paciente.email or 'N/A' }}</span></div>
                    <div class="data-item"><span class="label">Fecha de Nacimiento</span><span class="value">{{ paciente.fecha_nacimiento.strftime('%d/%m/%Y') if paciente.fecha_nacimiento else 'N/A' }}</span></div>
                    <div class="data-item"><span class="label">Edad</span><span class="value">{{ paciente.edad or 'N/A' }} años</span></div>
                    <div class="data-item"><span class="label">Género</span><span class="value">{{ paciente.genero or 'N/A' }}</span></div>
                    <div class="data-item"><span class="label">Estado Civil</span><span class="value">{{ paciente.estado_civil or 'N/A' }}</span></div>
                    <div class="data-item"><span class="label">Ocupación</span><span class="value">{{ paciente.ocupacion or 'N/A' }}</span></div>
                </div>
            </div>
            <div class="card-custom">
                <h3><i data-lucide="map-pin" class="card-icon"></i>Dirección y Aseguradora</h3>
                <div class="data-grid">
                    {{ render_campo('Dirección', 'direccion', paciente, editable=False) }}
                    {{ render_campo('Barrio', 'barrio', paciente, editable=False) }}
                    {{ render_campo('Municipio', 'municipio', paciente, editable=False) }}
                    {{ render_campo('Departamento', 'departamento', paciente, editable=False) }}
                    {{ render_campo('Aseguradora', 'aseguradora', paciente, editable=False) }}
                    {{ render_campo('Tipo de Vinculación', 'tipo_vinculacion', paciente, editable=False) }}
                </div>
            </div>
            <div class="card-custom">
                <h3><i data-lucide="shield" class="card-icon"></i>Datos del Responsable</h3>
                <div class="data-grid">
                    {{ render_campo('Nombre del Responsable', 'nombre_responsable', paciente, editable=False) }}
                    {{ render_campo('Teléfono del Responsable', 'telefono_responsable', paciente, editable=False) }}
                    {{ render_campo('Parentesco', 'parentesco', paciente, editable=False) }}
                    {{ render_campo('Referido por', 'referido_por', paciente, editable=False) }}
                </div>
            </div>
        </div>

        <!-- ======================================================= -->
        <!-- COLUMNA 2: HISTORIA CLÍNICA -->
        <!-- ======================================================= -->
        <div class="column"> {# <-- ESTE DIV FALTABA #}
            <div class="card-custom">
                <h3><i data-lucide="file-text" class="card-icon"></i>Antecedentes Personales</h3>
                <div class="data-grid">
                    {{ render_campo_textarea('Motivo de Consulta', 'motivo_consulta', paciente, editable=False) }}
                    {{ render_campo_textarea('Enfermedad Actual', 'enfermedad_actual', paciente, editable=False) }}
                    {{ render_campo_textarea('Antecedentes Personales', 'antecedentes_personales', paciente, editable=False) }}
                    {{ render_campo_textarea('Antecedentes Familiares', 'antecedentes_familiares', paciente, editable=False) }}
                    {{ render_campo_textarea('Antecedentes Quirúrgicos', 'antecedentes_quirurgicos', paciente, editable=False) }}
                    {{ render_campo_textarea('Antecedentes Hemorrágicos', 'antecedentes_hemorragicos', paciente, editable=False) }}
                    {{ render_campo_textarea('Farmacológicos', 'farmacologicos', paciente, editable=False) }}
                    {{ render_campo_textarea('Reacción a Medicamentos', 'reaccion_medicamentos', paciente, editable=False) }}
                    {{ render_campo_textarea('Alergias', 'alergias', paciente, editable=False) }}
                    {{ render_campo_textarea('Hábitos', 'habitos', paciente, editable=False) }}
                    {{ render_campo_textarea('Higiene Oral (Cepillado)', 'cepillado', paciente, editable=False) }}
                    {{ render_campo_textarea('Examen Físico', 'examen_fisico', paciente, editable=False) }}
                    {{ render_campo_textarea('Última Visita al Odontólogo', 'ultima_visita_odontologo', paciente, editable=False) }}
                </div>
            </div>
        </div>

        <!-- ======================================================= -->
        <!-- COLUMNA 3: IMÁGENES Y PLANIFICACIÓN -->
        <!-- ======================================================= -->
        <div class="column">
            <!-- Card para el Dentigrama (VISTA PREVIA) -->
            {% if paciente.dentigrama_url %}
            <div class="card-custom">
                <h3><i data-lucide="image" class="card-icon"></i>Dentigrama</h3>
                <div class="dentigrama-container" style="position: relative; cursor: pointer; max-width: 100%;" data-bs-toggle="modal" data-bs-target="#modalDentigrama" title="Haz clic para ampliar">
                    <div style="background-image: url('{{ url_for('static', filename='img/plantilla_dentigrama.png') }}'); background-size: contain; background-repeat: no-repeat; background-position: center;">
                        <div style="padding-top: 50%;"></div>
                        <img src="{{ paciente.dentigrama_url }}" alt="Dentigrama del paciente" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card para las Imágenes Adicionales -->
            {% if paciente.imagen_1_url or paciente.imagen_2_url %}
            <div class="card-custom">
                <h3><i data-lucide="images" class="card-icon"></i>Imágenes Adicionales</h3>
                <div class="gallery-grid">
                    {% if paciente.imagen_1_url %}
                    <div class="gallery-item" data-bs-toggle="modal" data-bs-target="#modalImagen1"><img src="{{ paciente.imagen_1_url }}" alt="Imagen 1"><h5>Imagen 1</h5></div>
                    {% endif %}
                    {% if paciente.imagen_2_url %}
                    <div class="gallery-item" data-bs-toggle="modal" data-bs-target="#modalImagen2"><img src="{{ paciente.imagen_2_url }}" alt="Imagen 2"><h5>Imagen 2</h5></div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Card para Plan de Tratamiento -->
            <div class="card-custom">
                <h3><i data-lucide="clipboard-list" class="card-icon"></i>Plan de Tratamiento</h3>
                <div class="data-grid">
                    {{ render_campo_textarea('Plan de Tratamiento', 'plan_tratamiento', paciente, editable=False) }}
                </div>
            </div>

            <!-- Card para Observaciones -->
            <div class="card-custom">
                <h3><i data-lucide="clipboard-list" class="card-icon"></i>Observaciones</h3>
                <div class="data-grid">
                    {{ render_campo_textarea('Observaciones', 'observaciones', paciente, editable=False) }}
                </div>
            </div>
        </div>

        <!-- ======================================================= -->
        <!-- COLUMNA 4: ACCIONES Y SEGUIMIENTO -->
        <!-- ======================================================= -->
        <div class="column">
            <div class="card-custom">
                <h3><i data-lucide="trending-up" class="card-icon"></i>Evolución</h3>
                <div class="evolucion-list mb-4">
                    {% for evolucion in paciente.evoluciones | sort(attribute='fecha', reverse=True) %}
                    <div class="evolucion-item">
                        <div class="evolucion-date">{{ evolucion.fecha.strftime('%d de %B, %Y') }}</div>
                        <p class="evolucion-desc">{{ evolucion.descripcion }}</p>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay evoluciones registradas.</p>
                    {% endfor %}
                </div>
                <hr>
                <h4 class="h6 mb-3 mt-4">Añadir Nueva Evolución</h4>
                <form action="{{ url_for('evoluciones.agregar_evolucion', paciente_id=paciente.id) }}" method="post" class="evolucion-form">
                    <div class="mb-3">
                        <textarea name="descripcion" class="form-control" rows="3" placeholder="Escribe aquí la nueva evolución..." required></textarea>
                    </div>
                    <button type="submit" class="btn-custom btn-secondary-custom w-100">Guardar Evolución</button>
                </form>
            </div>
            <div class="card-custom">
                <h3><i data-lucide="menu-square" class="card-icon"></i>Otras Acciones</h3>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('export.exportar_excel', id=paciente.id) }}" class="btn-custom btn-success-custom"><i data-lucide="file-spreadsheet" class="btn-icon"></i> Exportar a Excel</a>
                    <a href="{{ url_for('export.exportar_word', id=paciente.id) }}" class="btn-custom btn-info-custom"><i data-lucide="file-text" class="btn-icon"></i> Exportar a Word</a>
                </div>
            </div>
        </div>

    </div> <!-- FIN de .profile-layout -->
</div> <!-- FIN de .container-custom -->


<!-- =================================================================== -->
<!-- MODALES (VAN AL FINAL, JUSTO ANTES DEL ENDBLOCK) -->
<!-- =================================================================== -->

<!-- Modal para Dentigrama -->
<!-- Archivo: mostrar_paciente.html (al final) -->

{% if paciente.dentigrama_url %}
<div class="modal fade" id="modalDentigrama" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dentigrama de {{ paciente.nombres }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- 👇▼▼▼ INICIO DE LA SECCIÓN MODIFICADA ▼▼▼👇 -->
            <div class="modal-body">
                
                <!-- 1. Contenedor al que le aplicaremos el CSS -->
                <div class="dentigrama-modal-content">
                    
                    <!-- 2. Imagen de fondo -->
                    <img src="{{ url_for('static', filename='img/plantilla_dentigrama.png') }}" 
                         class="dentigrama-fondo" 
                         alt="Plantilla de dentigrama">
                    
                    <!-- 3. Imagen de los trazos que se superpone -->
                    <img src="{{ paciente.dentigrama_url }}" 
                         class="dentigrama-trazos" 
                         alt="Trazos del dentigrama">

                </div>

            </div>
            <!-- ▲▲▲ FIN DE LA SECCIÓN MODIFICADA ▲▲▲ -->

        </div>
    </div>
</div>
{% endif %}

<!-- Modal para Imagen 1 -->
{% if paciente.imagen_1_url %}
<div class="modal fade" id="modalImagen1" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-body"><img src="{{ paciente.imagen_1_url }}" class="img-fluid" alt="Imagen 1"></div></div></div>
</div>
{% endif %}

<!-- Modal para Imagen 2 -->
{% if paciente.imagen_2_url %}
<div class="modal fade" id="modalImagen2" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-body"><img src="{{ paciente.imagen_2_url }}" class="img-fluid" alt="Imagen 2"></div></div></div>
</div>
{% endif %}

{% endblock %}